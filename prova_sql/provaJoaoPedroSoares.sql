CREATE DATABASE ESCOLA
USE ESCOLA

CREATE TABLE ALUNO(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    NOME VARCHAR(40),
    CPF VARCHAR(12),
    DT_NASC DATE
)
CREATE TABLE PROFESSOR(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    NOME VARCHAR(40),
    ATIVO BIT DEFAULT 1
)
CREATE TABLE CURSO(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    NOME VARCHAR(40),
    ATIVO BIT DEFAULT 1
)
CREATE TABLE DISCIPLINA(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    NOME VARCHAR(40),
    ATIVO BIT DEFAULT 1
)

CREATE TABLE DISCIPLINA_CURSO(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    ID_CURSO INT FOREIGN KEY (ID_CURSO) REFERENCES CURSO(ID),
    ID_DISCIPLINA INT FOREIGN KEY (ID_DISCIPLINA) REFERENCES DISCIPLINA(ID),
    ATIVO BIT DEFAULT 1
)

INSERT DISCIPLINA_CURSO (ID_CURSO, ID_DISCIPLINA) VALUES
    (4, 5),
    (4, 7),
    (4, 6),
    (2, 1),
    (2, 2),
    (2, 3),
    (2, 4),
    (2, 8)


CREATE TABLE TURMA(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    ID_ALUNO INT FOREIGN KEY (ID_ALUNO) REFERENCES ALUNO(ID),
    ID_PROF INT FOREIGN KEY (ID_PROF) REFERENCES PROFESSOR(ID),
    ID_DISCIPLINA_CURSO INT FOREIGN KEY (ID_DISCIPLINA_CURSO) REFERENCES DISCIPLINA_CURSO(ID),
    NOTA1 FLOAT,
    NOTA2 FLOAT,
    NOTA3 FLOAT,
    NOTA4 FLOAT,
    NOTA_FINAL FLOAT,
    ATIVA BIT DEFAULT 1
)


SELECT * FROM TURMA
CREATE TABLE PAGAMENTOS(
    ID INT IDENTITY(1,1) PRIMARY KEY,
    ID_ALUNO INT FOREIGN KEY (ID_ALUNO) REFERENCES ALUNO(ID),
    BOLETO DATE,
    SITUACAO VARCHAR(10) CHECK(SITUACAO IN('EM ATRASO', 'PAGO', 'PENDENTE')) 
)

--6- Crie as seguintes views 
-- Que mostre os nomes dos alunos, nomes das disciplinas e as notas em cada uma delas
-- que mostre o nome dos alunos que possuam boleto em atraso 




CREATE VIEW JOAO AS
SELECT A.NOME, P.SITUACAO FROM PAGAMENTOS P
JOIN ALUNO A
ON P.ID_ALUNO = A.ID
WHERE SITUACAO = 'EM ATRASO'

SELECT * FROM JOAO
SELECT * FROM TURMA
SELECT * FROM DISCIPLINA_CURSO

CREATE VIEW JOAO2 AS 
SELECT A.NOME,C.NOME AS CURSO, DI.NOME AS DISCIPLINA, NOTA1, NOTA2, NOTA3 ,NOTA4, NOTA_FINAL FROM TURMA T
JOIN ALUNO A
ON A.ID = T.ID_ALUNO 
JOIN DISCIPLINA_CURSO D
ON T.ID_DISCIPLINA_CURSO = D.ID 
JOIN DISCIPLINA DI
ON DI.ID = D.ID_DISCIPLINA
JOIN CURSO C
ON C.ID = D.ID_CURSO

SELECT *FROM JOAO2

-- Faça um update na tabela pagamento, colocando na coluna ‘situação’ o status de ‘em atraso’ 
--para todos os boleto cujo a data seja maior que a data atual e a coluna ‘situação’ esteja como ‘pendente’
-- mostre as disciplinas recebendo o nome do aluno como parâmetro

SELECT * FROM PAGAMENTOS WHERE SITUACAO = 'PENDENTE' AND BOLETO > GETDATE()
CREATE OR ALTER PROC VERIFICA_PAGAMENTO
AS BEGIN 
    UPDATE PAGAMENTOS 
    SET SITUACAO = 'EM ATRASO'
    WHERE SITUACAO = 'PENDENTE' AND BOLETO > GETDATE()
END

EXEC VERIFICA_PAGAMENTO

--Crie uma trigger para que quando uma disciplina  ou curso for inativado, 
--os registros da tabela ‘disciplina x curso’ que fazem referência à eles sejam atualizadas na coluna ‘ativa’ para o valor ‘0’.
-- E outra trigger para que quando a coluna ‘ativa’ da tabela ‘disciplina x curso’ for atualizada para ‘0’, 
--todos os registros da tabela ‘turma’ que fazem referência à ela também sejam atualizadas para ‘0’


CREATE OR ALTER TRIGGER TURMA_UPDATE ON DISCIPLINA_CURSO
AFTER UPDATE 
AS BEGIN
    DECLARE @STATUS BIT
    DECLARE @ID_TURMA INT
    SELECT @STATUS = ATIVO, @ID_TURMA = ID FROM INSERTED
    UPDATE TURMA SET ATIVA = @STATUS
    FROM TURMA WHERE ID_DISCIPLINA_CURSO = @ID_TURMA
END

SELECT *FROM TURMA
SELECT *FROM DISCIPLINA_CURSO

UPDATE DISCIPLINA
SET ATIVO = 0
WHERE ID = 2 


CREATE OR ALTER TRIGGER DISC_UPDATE ON DISCIPLINA
AFTER UPDATE 
AS BEGIN
    DECLARE @STATUS BIT
    DECLARE @ID_DISC INT
    SELECT @STATUS = ATIVO, @ID_DISC = ID FROM INSERTED
    UPDATE DISCIPLINA_CURSO SET ATIVO = @STATUS
    FROM DISCIPLINA_CURSO WHERE ID_DISCIPLINA = @ID_DISC
END


SELECT *FROM DISCIPLINA

UPDATE DISCIPLINA
SET ATIVO = 0
WHERE ID = 2 



CREATE OR ALTER TRIGGER DISC_UPDATE_CURSO ON CURSO
AFTER UPDATE 
AS BEGIN
    DECLARE @STATUS BIT
    DECLARE @ID_CURSO INT
    SELECT @STATUS = ATIVO, @ID_CURSO = ID FROM INSERTED
    UPDATE DISCIPLINA_CURSO SET ATIVO = @STATUS
    FROM DISCIPLINA_CURSO WHERE ID_CURSO = @ID_CURSO
END

SELECT *FROM DISCIPLINA_CURSO

SELECT *FROM CURSO

UPDATE CURSO
SET ATIVO = 1
WHERE ID = 2 















INSERT PAGAMENTOS (ID_ALUNO, BOLETO, SITUACAO) VALUES 
    (1, '11-10-2022', 'PAGO'),
    (1, '12-22-2022', 'PENDENTE'),
    (2, '11-10-2022', 'PAGO'),
    (2, '12-22-2022', 'PENDENTE'),
    (3, '11-10-2022', 'PAGO'),
    (3, '12-22-2022', 'PENDENTE'),
    (4, '11-10-2022', 'PAGO'),
    (4, '12-22-2022', 'PENDENTE'),
    (5, '11-10-2022', 'PAGO'),
    (5, '12-22-2022', 'PENDENTE'),

    (6, '12-12-2022', 'PAGO'),
    (6, '12-11-2022', 'PAGO'),
    (6, '12-12-2022', 'PENDENTE'),
    (7, '12-12-2022', 'PAGO'),
    (7, '12-11-2022', 'PAGO'),
    (7, '12-12-2022', 'PENDENTE'),
    (8, '12-12-2022', 'PAGO'),
    (8, '12-11-2022', 'PAGO'),
    (8, '12-12-2022', 'PENDENTE'),
    (9, '12-12-2022', 'PAGO'),
    (9, '12-11-2022', 'PAGO'),
    (9, '12-12-2022', 'PENDENTE'),
    (10, '12-12-2022', 'PAGO'),
    (10, '12-11-2022', 'PAGO'),
    (10, '12-12-2022', 'PENDENTE'),
    (11, '12-12-2022', 'PAGO'),
    (11, '12-11-2022', 'PAGO'),
    (11, '12-12-2022', 'PENDENTE'),
    (12, '12-12-2022', 'PAGO'),
    (12, '12-11-2022', 'PAGO'),
    (12, '12-12-2022', 'PENDENTE'),
    (13, '12-12-2022', 'PAGO'),
    (13, '12-11-2022', 'PAGO'),
    (13, '12-12-2022', 'PENDENTE'),
    (14, '12-12-2022', 'PAGO'),
    (14, '12-11-2022', 'PAGO'),
    (14, '12-12-2022', 'PENDENTE'),
    (15, '12-12-2022', 'PAGO'),
    (15, '12-11-2022', 'PAGO'),
    (15, '12-12-2022', 'PENDENTE'),

    (16, '12-12-2022', 'PAGO'),
    (16, '11-11-2022', 'PAGO'),
    (16, '10-11-2022', 'PAGO'),
    (16, '09-11-2022', 'PAGO'),
    (16, '12-12-2022', 'PENDENTE'),
    (17, '12-12-2022', 'PAGO'),
    (17, '11-11-2022', 'PAGO'),
    (17, '10-11-2022', 'PAGO'),
    (17, '09-11-2022', 'PAGO'),
    (17, '12-12-2022', 'PENDENTE'),
    (18, '12-12-2022', 'PAGO'),
    (18, '11-11-2022', 'PAGO'),
    (18, '10-11-2022', 'PAGO'),
    (18, '09-11-2022', 'PAGO'),
    (18, '12-12-2022', 'PENDENTE'),

    (19, '11-11-2022', 'PAGO'),
    (19, '10-11-2022', 'PAGO'),
    (19, '09-11-2022', 'PAGO'),
    (19, '01-12-2022', 'PENDENTE'),
    (20, '11-11-2022', 'PAGO'),
    (20, '10-11-2022', 'PAGO'),
    (20, '09-11-2022', 'PAGO'),
    (20, '01-12-2022', 'PENDENTE')








INSERT ALUNO(NOME, CPF, DT_NASC) VALUES 
    ('JOAO PAULO', '171923044-33', '11-11-2111'),
    ('PEDRO PAULO', '171924456-33', '11-11-3011'),
    ('PAULO PAULO', '171443056-33', '11-12-2011'),
    ('JOAO JOAO', '174423056-33', '12-11-2051'),
    ('JOAO PEIDO', '144923056-33', '11-11-2211'),
    ('LUCAS PAULO', '441923056-33', '11-10-2011'),
    ('PAULO LUCAS', '221923056-33', '09-11-2011'),
    ('JOAO IGOR', '172223056-33', '11-09-2011'),
    ('IGOR PAULO', '171922256-33', '11-01-2011'),
    ('MATEUS PAULO', '171923226-33', '09-11-2011'),
    ('PAULO MATEUS', '171923056-22', '11-05-2011'),
    ('AMADEU', '171923056-55', '11-03-2011'),
    ('IGOR', '171923055-33', '11-11-2081'),
    ('JOAO LUCAS', '175523056-33', '11-11-2021'),
    ('JOAO GUSTAVO', '551923056-33', '11-12-2014'),
    ('JOAO JOCCA', '171925556-33', '01-12-2041'),
    ('JOCCA PAULO', '171883056-33', '11-12-2022'),
    ('MARIA JOAO', '171923886-33', '07-12-2051'),
    ('DIRCLEY', '171923056-88', '08-06-2011'),
    ('EDVALDO', '171923056-99', '06-10-2019'),
    ('GUSTAVO LIMA', '171923000-33', '11-11-2011')


INSERT PROFESSOR(NOME) VALUES
    ('GUSTAVO LIMA'),
    ('LUCAS LUCCO'),
    ('PAULA FERNANDES'),
    ('LUDMILLA'),
    ('FABIO DE MELO')

INSERT CURSO(NOME) VALUES
    ('ENG MECANICA'),
    ('SISTEMAS DE INFORMACAO'),
    ('ENG ELETRICA'),
    ('MEDICINA')
INSERT CURSO(NOME, ATIVO) VALUES ('ENG SOFTWARE', 0)

INSERT DISCIPLINA(NOME) VALUES
    ('CALCULO 1'),
    ('PROGRAMACAO 1'),
    ('INTRODUCAO A BANCO DE DADOS'),
    ('MATEMATICA DISCRETA'),
    ('ANATOMIA'),
    ('PARTES DO CORPO HUMANO'),
    ('SOCIOLOGIA'),
    ('FISICA 1'),
    ('PROLEGOMENOS AO COMPUTAR'),
    ('CALCULO 2')
INSERT DISCIPLINA(NOME, ATIVO) VALUES ('PROGRAMACAO ORIENTEDA A OBJETOS', 0)

SELECT * FROM DISCIPLINA

INSERT TURMA (ID_ALUNO,ID_PROF, ID_DISCIPLINA_CURSO, NOTA1, NOTA2, NOTA3, NOTA_FINAL) VALUES
    (1,1,4,9.0,8.0,7.0,(9.0+8.0+7.0)/4),
    (2,1,4,9.0,10.0,8.0,(9.0+10.0+8.0)/4),
    (3,1,4,2.0,3.0,4.0,(2.0+3.0+4.0)/4),
    (4,1,4,1.0,10.0,5.0,(1.0+10.0+5.0)/4),
    (5,1,4,4.0,5.0,5.0,(4.0+5.0+5.0)/4)

INSERT TURMA (ID_ALUNO,ID_PROF, ID_DISCIPLINA_CURSO, NOTA1, NOTA_FINAL) VALUES
    (6,2,5,2.0,(2.0)/4),
    (7,2,5,2.0,(2.0)/4),
    (8,2,5,3.0,(3.0)/4),
    (9,2,5,9.0,(9.0)/4),
    (10,2,5,9.0,(9.0)/4)

INSERT TURMA (ID_ALUNO,ID_PROF, ID_DISCIPLINA_CURSO, NOTA1, NOTA2, NOTA_FINAL) VALUES
    (11,3,6,9.0,8.0,(9.0+8.0)/4),
    (12,3,6,9.0,10.0,(9.0+10.0)/4),
    (13,3,6,2.0,3.0,(2.0+3.0)/4),
    (14,3,6,1.0,10.0,(1.0+10.0)/4),
    (15,3,6,4.0,5.0,(4.0+5.0)/4),

    (16,4,7,2.0,2.0,(2.0+2.0)/4),
    (17,4,7,2.0,2.0,(2.0+2.0)/4),
    (18,4,7,3.0,3.0,(3.0+3.0)/4),
    (19,4,7,9.0,8.0,(9.0+8.0)/4),
    (20,4,7,9.0,10.0,(9.0+10.0)/4)

